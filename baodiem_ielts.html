<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Score Report</title>
    <style>
        @page {
            size: A4;
            margin: 0;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Times New Roman', Times, serif;
        }

        .a4-page {
            width: 210mm;
            height: 297mm;
            padding: 15mm;
            margin: 0 auto;
            background-color: white;
            position: relative;
            box-sizing: border-box;
        }

        @media print {
            .a4-page {
                width: 210mm;
                height: 297mm;
                margin: 0;
                padding: 15mm;
                page-break-after: avoid;
            }

            body {
                background-color: white;
            }

            .print-button {
                display: none;
            }
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            font-size: 12pt;
            vertical-align: middle;
        }

        .header {
            border-bottom: 2px solid #00366f;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .section-title {
            font-weight: bold;
            font-size: 14pt;
            color: #00366f;
            padding: 5px 0;
            margin: 12px 0 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .blue-text {
            color: #00366f;
        }

        .progress-bar {
            background-color: #00366f;
            height: 18px;
            width: 35px;
            border-radius: 2px;
        }

        .signature-row td {
            height: 60px;
            vertical-align: bottom;
        }

        .print-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #00366f;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Times New Roman', Times, serif;
        }

        .score-box {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 10px 15px;
            margin: 10px 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .score-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .score-icon {
            width: 24px;
            margin-right: 10px;
            text-align: center;
        }

        .score-label {
            width: 80px;
        }

        .score-value {
            margin-left: auto;
            font-weight: bold;
        }

        .comments-box {
            height: auto !important;
            /* Thay v√¨ height: 70px; c·ªë ƒë·ªãnh */
            min-height: 70px;
            max-height: 300px;
            /* Ho·∫∑c m·ªôt gi√° tr·ªã ph√π h·ª£p */
            overflow-y: auto;
            /* Cho ph√©p cu·ªôn n·∫øu n·ªôi dung qu√° d√†i */
            white-space: normal;
            /* ƒê·∫£m b·∫£o text xu·ªëng d√≤ng ƒë√∫ng */
            word-wrap: break-word;
            /* X·ª≠ l√Ω t·ª´ d√†i */
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            margin-top: 10px;
            border-radius: 4px;
            padding: 5px;
            background-color: #f8fafc;
        }

        .detail-table td {
            padding: 6px 8px;
        }

        .footer {
            margin-top: 20px;
            text-align: right;
        }

        .logo {
            font-size: 20pt;
            font-weight: bold;
            color: #00366f;
        }

        .candidate-info {
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            background-color: #f8fafc;
        }

        .overall-score {
            font-size: 16pt;
            font-weight: bold;
            color: #00366f;
            border-top: 1px solid #e2e8f0;
            padding-top: 5px;
            margin-top: 5px;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="a4-page">
        <div class="header">
            <table>
                <tr>
                    <td width="25%" class="logo"><img src="https://rndwows.github.io/leaedu/LOGO.jpg" width="70px"
                            alt=""></td>
                    <td width="50%" class="text-center blue-text" style="font-weight: bold; font-size: 18pt;">IELTS
                        SCORE REPORT</td>
                    <td width="25%"></td>
                </tr>
            </table>
            <table>
                <tr>
                    <td colspan="3" class="blue-text" style="font-weight: bold; font-size: 14pt;">LEA ENGLISH CENTER
                    </td>
                </tr>
                <tr>
                    <td colspan="3" style="font-style: italic;">Hotline: 0274.9999.899 / 0985.914.415</td>
                </tr>
            </table>
        </div>

        <div class="candidate-info">
            <table>
                <tr>
                    <td width="50%"><b>Candidate's Name:</b> ________________</td>
                    <td width="50%"><b>Test date:</b> ________________</td>
                </tr>
            </table>
        </div>

        <div class="section-title">I. SCORES BY SKILLS AND OVERALL BAND</div>
        <div class="score-box">
            <div class="score-item">
                <div class="score-icon">üéß</div>
                <div class="score-label">Listening</div>
                <div class="score-value">8.0</div>
            </div>
            <div class="score-item">
                <div class="score-icon">üìñ</div>
                <div class="score-label">Reading</div>
                <div class="score-value">9.0</div>
            </div>
            <div class="score-item">
                <div class="score-icon">‚úèÔ∏è</div>
                <div class="score-label">Writing</div>
                <div class="score-value">
                    <div class="progress-bar"></div>
                </div>
            </div>
            <div class="score-item">
                <div class="score-icon">üó£Ô∏è</div>
                <div class="score-label">Speaking</div>
                <div class="score-value">7.5</div>
            </div>
            <div class="score-item overall-score">
                <div class="score-icon"></div>
                <div class="score-label">Overall</div>
                <div class="score-value">8.0</div>
            </div>
        </div>

        <div class="section-title">II. DETAILED SCORES</div>
        <table class="detail-table">
            <tr>
                <td width="50%" style="font-weight: bold; color: #00366f;">Speaking (Scores based on 4 criteria):</td>
                <td width="50%" style="font-weight: bold; color: #00366f;">Writing (Scores based on 4 criteria):</td>
            </tr>
            <tr>
                <td>Fluency and Coherence: _____</td>
                <td>Task Achievement / Task Response: _____</td>
            </tr>
            <tr>
                <td>Lexical Resource: _____</td>
                <td>Coherence and Cohesion: _____</td>
            </tr>
            <tr>
                <td>Grammatical Range and Accuracy: _____</td>
                <td>Lexical Resource: _____</td>
            </tr>
            <tr>
                <td>Pronunciation: _____</td>
                <td>Grammatical Range and Accuracy: _____</td>
            </tr>
            <tr>
                <td><b>Total Speaking Score: _____</b></td>
                <td><b>Total Writing Score: _____</b></td>
            </tr>
        </table>

        <table class="detail-table" style="margin-top: 15px;">
            <tr>
                <td width="50%" style="font-weight: bold; color: #00366f;">Listening:</td>
                <td width="50%" style="font-weight: bold; color: #00366f;">Reading:</td>
            </tr>
            <tr>
                <td>Number of Correct Answers: _____</td>
                <td>Number of Correct Answers: _____</td>
            </tr>
            <tr>
                <td><b>Listening Band Score: _____</b></td>
                <td><b>Reading Band Score: _____</b></td>
            </tr>
        </table>

        <div class="section-title">III. COMMENTS</div>
        <div class="comments-box"></div>

        <div class="footer">
            <table>
                <tr>
                    <td width="60%"></td>
                    <td width="40%" class="text-center blue-text" style="font-weight: bold;">LEA ENGLISH CENTER</td>
                </tr>
                <tr class="signature-row">
                    <td></td>
                    <td></td>
                </tr>
                <tr>
                    <td></td>
                    <td class="text-center" style="border-top: 1px solid #00366f; padding-top: 5px;">Do Thi Kim Thuy
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <button class="print-button" onclick="window.print()">In b√°o c√°o</button>

    <script>
        const appId = '237238ed-4230-4db1-ab50-e492cea9cdba';
        const accessKey = 'V2-GAZkd-YsAqg-LBYbc-LRoOQ-2ZFzj-Imfj1-SodbW-9RtwD';
        const region = 'www';

        // Function to get URL parameters
        function getUrlParameter(name) {
            const url = window.location.href;
            const keyrowIndex = url.indexOf('?keyrow=');

            if (keyrowIndex === -1) {
                return '';
            }

            const fullKeyrow = url.substring(keyrowIndex + 8); // +8 to skip '?keyrow='
            console.log('Full keyrow parameter:', fullKeyrow);

            // If you need just the first part before the &
            // const keyrow = fullKeyrow.split('&')[0];

            // If KEYROW is actually the combination of all parts
            // Remove any trailing parameters if needed
            const keyrow = fullKeyrow.includes('?') ?
                fullKeyrow.substring(0, fullKeyrow.indexOf('?')) :
                fullKeyrow;

            console.log('Extracted keyrow:', keyrow);
            return keyrow;
        }

        // Function to fetch data from AppSheet API
        async function fetchIeltsData() {
            try {
                const keyrow = getUrlParameter('keyrow');
                if (!keyrow) {
                    console.error('No keyrow parameter found in URL');
                    return;
                }

                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/IELTS/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {
                            Selector: `Filter(IELTS, [KEYROW] = "${keyrow}")`
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error('No data found for the provided keyrow');
                }

                // Make sure we only get the record with the exact keyrow
                const ieltsRecord = data.find(record => record['KEYROW'] === keyrow);

                if (!ieltsRecord) {
                    throw new Error('No exact match found for the provided keyrow');
                }

                // Fill in the form with the retrieved data
                populateScoreReport(ieltsRecord);
            } catch (error) {
                console.error('Failed to fetch IELTS data:', error);
            }
        }

        // Function to populate the score report with data
        function populateScoreReport(data) {
            try {
                // Safely update elements with null checks
                const updateElement = (selector, content) => {
                    const element = document.querySelector(selector);
                    if (element) {
                        element.innerHTML = content;
                    } else {
                        console.warn(`Element not found: ${selector}`);
                    }
                };

                // Writing score
                updateElement('.score-item:nth-child(3) .score-value', data['Writing'] || '');

                // Candidate info
                updateElement('.candidate-info td:nth-child(1)', `<b>Candidate's Name:</b> ${data['T√™n KH'] || ''}`);
                updateElement('.candidate-info td:nth-child(2)', `<b>Test date:</b> ${formatDate(data['Ng√†y nh·∫≠p ƒëi·ªÉm']) || ''}`);

                // Main scores
                updateElement('.score-item:nth-child(1) .score-value', data['ƒêi·ªÉm Listening'] || '');
                updateElement('.score-item:nth-child(2) .score-value', data['ƒêi·ªÉm Reading'] || '');
                updateElement('.score-item:nth-child(4) .score-value', data['Speaking'] || '');
                updateElement('.overall-score .score-value', data['T·ªïng ƒëi·ªÉm'] || '');

                // Speaking details
                updateElement('.detail-table tr:nth-child(2) td:nth-child(1)', `Fluency and Coherence: ${data['Speaking Fluency'] || ''}`);
                updateElement('.detail-table tr:nth-child(3) td:nth-child(1)', `Lexical Resource: ${data['Speaking Lexical'] || ''}`);
                updateElement('.detail-table tr:nth-child(4) td:nth-child(1)', `Grammatical Range and Accuracy: ${data['Speaking Grammar'] || ''}`);
                updateElement('.detail-table tr:nth-child(5) td:nth-child(1)', `Pronunciation: ${data['Speaking Pronunciation'] || ''}`);
                updateElement('.detail-table tr:nth-child(6) td:nth-child(1)', `<b>Total Speaking Score: ${data['Speaking'] || ''}</b>`);

                // Writing details
                updateElement('.detail-table tr:nth-child(2) td:nth-child(2)', `Task Achievement / Task Response: ${data['Writing Task Achievement'] || ''}`);
                updateElement('.detail-table tr:nth-child(3) td:nth-child(2)', `Coherence and Cohesion: ${data['Writing Coherence/Cohesion'] || ''}`);
                updateElement('.detail-table tr:nth-child(4) td:nth-child(2)', `Lexical Resource: ${data['Writing Lexical Resource'] || ''}`);
                updateElement('.detail-table tr:nth-child(5) td:nth-child(2)', `Grammatical Range and Accuracy: ${data['Writing Grammar Accuracy'] || ''}`);
                updateElement('.detail-table tr:nth-child(6) td:nth-child(2)', `<b>Total Writing Score: ${data['Writing'] || ''}</b>`);

                // Listening and Reading
                updateElement('.detail-table:nth-of-type(2) tr:nth-child(2) td:nth-child(1)', `Number of Correct Answers: ${data['Listening'] || ''}`);
                updateElement('.detail-table:nth-of-type(2) tr:nth-child(2) td:nth-child(2)', `Number of Correct Answers: ${data['Reading'] || ''}`);
                updateElement('.detail-table:nth-of-type(2) tr:nth-child(3) td:nth-child(1)', `<b>Listening Band Score: ${data['ƒêi·ªÉm Listening'] || ''}</b>`);
                updateElement('.detail-table:nth-of-type(2) tr:nth-child(3) td:nth-child(2)', `<b>Reading Band Score: ${data['ƒêi·ªÉm Reading'] || ''}</b>`);

                // Comments
                updateElement('.comments-box', data['Nh·∫≠n x√©t'] || '');

                // Teacher signature
                updateElement('.footer tr:nth-child(3) td:nth-child(2)', data['Gi√°o vi√™n'] || 'Do Thi Kim Thuy');

                console.log('Score report populated successfully');
            } catch (error) {
                console.error('Error in populateScoreReport:', error);
            }
        }
        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            } catch (e) {
                return dateString;
            }
        }

        // Initialize when the page loads
        document.addEventListener('DOMContentLoaded', fetchIeltsData);
    </script>
</body>

</html>