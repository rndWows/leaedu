<!DOCTYPE html>
<html lang="vi" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thống kê KH</title>
    <link rel="shortcut icon"
        href="https://lea.edu.vn/wp-content/uploads/2023/07/removal.ai_9476a724-4e89-400f-a9e4-e6f4d9c4503d-logo-vector-1.png"
        type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        warning: '#EF4444',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .content-wrapper {
            display: flex;
            flex: 1;
        }

        .navbar {
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .sidebar {
            position: sticky;
            top: 64px;
            /* Adjust based on navbar height */
            height: calc(100vh - 64px);
            overflow-y: auto;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        @media (max-width: 768px) {
            .content-wrapper {
                flex-direction: column;
            }

            .sidebar {
                position: static;
                height: auto;
            }
        }
    </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900">
    <!-- Navbar -->
    <nav class="navbar bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-9xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <img class="h-8 w-auto"
                        src="https://lea.edu.vn/wp-content/uploads/2023/07/removal.ai_9476a724-4e89-400f-a9e4-e6f4d9c4503d-logo-vector-1.png"
                        alt="LEA EDU VN">
                </div>
                <div class="flex items-center">
                    <button id="darkModeToggle"
                        class="p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500">
                        <span class="sr-only">Toggle dark mode</span>
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="content-wrapper">
        <!-- Sidebar -->
        <aside class="sidebar bg-white dark:bg-gray-800 shadow">
            <div class="p-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Bộ lọc</h3>
                <div class="space-y-4">
                    <!-- Filter inputs -->
                    <div>
                        <label for="nguonTiepnhanFilter"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nguồn tiếp nhận</label>
                        <select id="nguonTiepnhanFilter"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                            <option value="">Tất cả</option>
                        </select>
                    </div>
                    <!-- Add other filter inputs here -->
                    <div class="flex space-x-2">
                        <button id="applyFilters"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-filter mr-2"></i>Áp dụng
                        </button>
                        <button id="exportExcel"
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                            <i class="fas fa-file-excel mr-2"></i>
                        </button>
                        <button id="resetFilters"
                            class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            <i class="fas fa-undo mr-2"></i>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Stats Grid -->
            <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-5 mb-6">
                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-indigo-500 rounded-md p-3">
                                <i class="fas fa-users text-white"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">
                                        Tổng số khách hàng
                                    </dt>
                                    <dd>
                                        <div class="text-lg font-medium text-gray-900 dark:text-white">
                                            0
                                        </div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-indigo-500 rounded-md p-3">
                                <i class="fas fa-user-graduate text-white"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">
                                        Tổng số học viên
                                    </dt>
                                    <dd>
                                        <div class="text-lg font-medium text-gray-900 dark:text-white">
                                            0
                                        </div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-indigo-500 rounded-md p-3">
                                <i class="fas fa-dollar-sign text-white"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">
                                        Doanh thu
                                    </dt>
                                    <dd>
                                        <div class="text-lg font-medium text-gray-900 dark:text-white">
                                            0
                                        </div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-indigo-500 rounded-md p-3">
                                <i class="fas fa-chalkboard-teacher text-white"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">
                                        Lớp đang hoạt động
                                    </dt>
                                    <dd>
                                        <div class="text-lg font-medium text-gray-900 dark:text-white">
                                            0
                                        </div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 bg-indigo-500 rounded-md p-3">
                                <i class="fas fa-handshake text-white"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 dark:text-gray-400 truncate">
                                        Số lần chăm sóc khách hàng
                                    </dt>
                                    <dd>
                                        <div class="text-lg font-medium text-gray-900 dark:text-white">
                                            0
                                        </div>
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="space-y-6">
                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Biểu đồ phát sinh
                            khách hàng theo thời gian</h3>
                        <div id="customerGrowthChart" style="height: 400px;"></div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Học viên phát sinh
                        </h3>
                        <div id="studentGrowthChart" style="height: 400px;"></div>
                    </div>
                </div>
                <div class="bg-white dark:bg-gray-800 overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">Biểu đồ doanh thu
                            lợi nhuận </h3>
                        <div id="revenueChart" style="height: 400px;"></div>
                    </div>
                </div>
                <!-- Add more chart sections if needed -->
            </div>
        </main>
    </div>
    <script>
        const appId = '237238ed-4230-4db1-ab50-e492cea9cdba';
        const accessKey = 'V2-GAZkd-YsAqg-LBYbc-LRoOQ-2ZFzj-Imfj1-SodbW-9RtwD';
        const region = 'www';

        let dskh = []

        // DOM elements
        const darkModeToggle = document.getElementById('darkModeToggle');
        const htmlElement = document.documentElement;


        // Utility functions
        const formatCurrency = amount => new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        const formatDate = dateString => {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        };

        // Dark mode toggle
        function toggleDarkMode() {
            htmlElement.classList.toggle('dark');
            localStorage.setItem('darkMode', htmlElement.classList.contains('dark'));
            updateDarkModeIcon();
        }

        function updateDarkModeIcon() {
            darkModeToggle.innerHTML = htmlElement.classList.contains('dark')
                ? '<i class="fas fa-sun"></i>'
                : '<i class="fas fa-moon"></i>';
        }

        // API request function
        async function apiRequest(tableName, action, data, Properties) {
            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: action,
                        ...Properties,
                        ...data
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error("API Error:", error);
                throw error;
            }
        }

        // Fetch data from API
        async function getdskh() {


            try {
                const response = await apiRequest('KHCN', 'Find', {}, {
                    Properties: { Selector: `Filter(KHCN, true)` }
                });
                if (!Array.isArray(response) || response.length === 0) {
                    throw new Error("Invalid data received from API");
                }
                return response;
            } catch (error) {
                console.error("Error fetching data from AppSheet:", error);
                throw error;
            }
        }
        // Utility function to get random data
        function getRandomData(count, max) {
            return Array.from({ length: count }, () => Math.floor(Math.random() * max));
        }



        // Utility function to get random data
        function getRandomData(count, max) {
            return Array.from({ length: count }, () => Math.floor(Math.random() * max));
        }

        // Chart 1: Biểu đồ phát sinh khách hàng theo thời gian
        function createCustomerGrowthChart() {
            Highcharts.chart('customerGrowthChart', {
                chart: {
                    type: 'area'
                },
                title: {
                    text: 'Biểu đồ phát sinh khách hàng theo thời gian'
                },
                xAxis: {
                    categories: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5' , 'Tháng 6' , 'Tháng 7' , 'Tháng 8' , 'Tháng 9' , 'Tháng 10' , 'Tháng 11' , 'Tháng 12'],
                    tickmarkPlacement: 'on',
                    title: {
                        enabled: false
                    }
                },
                yAxis: {
                    title: {
                        text: 'Số lượng khách hàng'
                    }
                },
                tooltip: {
                    split: true,
                    valueSuffix: ' khách hàng'
                },
                plotOptions: {
                    area: {
                        stacking: 'normal',
                        lineColor: '#666666',
                        lineWidth: 1,
                        marker: {
                            lineWidth: 1,
                            lineColor: '#666666'
                        }
                    }
                },
                series: [{
                    name: 'Khách hàng mới',
                    data: getRandomData(12, 100)
                }, {
                    name: 'Đã chốt',
                    data: getRandomData(12, 50)
                }]
            });
        }

        // Chart 2: Học viên phát sinh
        function createStudentGrowthChart() {
            Highcharts.chart('studentGrowthChart', {
                chart: {
                    type: 'column'
                },
                title: {
                    text: 'Học viên phát sinh'
                },
                xAxis: {
                    categories: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5' , 'Tháng 6' , 'Tháng 7' , 'Tháng 8' , 'Tháng 9' , 'Tháng 10' , 'Tháng 11' , 'Tháng 12'],
                    crosshair: true
                },
                yAxis: {
                    min: 0,
                    title: {
                        text: 'Số lượng học viên'
                    }
                },
                tooltip: {
                    headerFormat: '<span style="font-size:10px">{point.key}</span><table>',
                    pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
                        '<td style="padding:0"><b>{point.y} học viên</b></td></tr>',
                    footerFormat: '</table>',
                    shared: true,
                    useHTML: true
                },
                plotOptions: {
                    column: {
                        pointPadding: 0.2,
                        borderWidth: 0
                    }
                },
                series: [{
                    name: 'Học viên mới',
                    data: getRandomData(12, 80)
                }, {
                    name: 'Học viên tiếp tục',
                    data: getRandomData(12, 120)
                }]
            });
        }

        // Chart 3: Biểu đồ doanh thu lợi nhuận
        function createRevenueChart() {
            Highcharts.chart('revenueChart', {
                chart: {
                    type: 'line'
                },
                title: {
                    text: 'Biểu đồ doanh thu lợi nhuận'
                },
                xAxis: {
                    categories: ['Tháng 1', 'Tháng 2', 'Tháng 3', 'Tháng 4', 'Tháng 5' , 'Tháng 6' , 'Tháng 7' , 'Tháng 8' , 'Tháng 9' , 'Tháng 10' , 'Tháng 11' , 'Tháng 12']

                },
                yAxis: {
                    title: {
                        text: 'Số tiền (VNĐ)'
                    }
                },
                plotOptions: {
                    line: {
                        dataLabels: {
                            enabled: true,
                            format: '{point.y:,.0f} VNĐ'
                        },
                        enableMouseTracking: false
                    }
                },
                series: [{
                    name: 'Doanh thu',
                    data: getRandomData(12, 1000000000).map(x => x * 1000)
                }, {
                    name: 'Lợi nhuận',
                    data: getRandomData(12, 500000000).map(x => x * 1000)
                }]
            });
        }

      

        // Initialize charts
        function initCharts() {
            createCustomerGrowthChart();
            createStudentGrowthChart();
            createRevenueChart();
        }




        async function init() {
            try {
                dskh = await getdskh();
                console.log(dskh)
                initCharts()
            } catch (error) {
                console.error("Error initializing app:", error);
                alert("Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại sau.");
            }
        }

        // Event listeners
        darkModeToggle.addEventListener('click', toggleDarkMode);



        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
        
        // Set initial dark mode based on user preference
        if (localStorage.getItem('darkMode') === 'true') {
            htmlElement.classList.add('dark');
        }
        updateDarkModeIcon();

    </script>
</body>

</html>
