<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEA Dashboard</title>
    <title>Thống kê KH</title>
    <link rel="shortcut icon"
        href="https://lea.edu.vn/wp-content/uploads/2023/07/removal.ai_9476a724-4e89-400f-a9e4-e6f4d9c4503d-logo-vector-1.png"
        type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .card-stats {
            transition: transform 0.2s ease-in-out;
        }

        .card-stats:hover {
            transform: translateY(-5px);
        }

        .sidebar {
            transition: all 0.3s ease;
        }


        .btn-primary {
            @apply bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors duration-200;
        }

        .btn-secondary {
            @apply bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors duration-200;
        }

        .btn-success {
            @apply bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors duration-200;
        }
    </style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <div id="loading" class="loading hidden">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-lg fixed top-0 left-0 right-0 z-30">
        <div class="max-w-9xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <button id="toggleFilters"
                        class="lg:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-bars text-gray-600 dark:text-gray-300"></i>
                    </button>
                    <div class="flex items-center space-x-3">
                        <img class="h-8 w-auto"
                            src="https://lea.edu.vn/wp-content/uploads/2023/07/removal.ai_9476a724-4e89-400f-a9e4-e6f4d9c4503d-logo-vector-1.png"
                            alt="LEA EDU VN">
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">LEA EDU VN</h1>
                    </div>
                </div>

            </div>
        </div>
    </header>

    <div class="flex min-h-screen pt-16">
        <!-- Sidebar -->
        <aside id="filtersSidebar"
            class="fixed left-0 top-16 bottom-0 w-64 bg-white dark:bg-gray-800 shadow-xl transform -translate-x-full lg:translate-x-0 transition-transform duration-200 ease-in-out overflow-y-auto z-20">
            <div class="p-6 space-y-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Bộ lọc</h2>
                </div>

                <div class="space-y-4">
                    <div class="filter-group">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Chi nhánh</label>
                        <select id="filterKhuVuc"
                            class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Giáo viên chủ
                            nhiệm</label>
                        <select id="filterChucVu"
                            class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Khóa học</label>
                        <select id="filterMaNhanVien"
                            class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </select>
                    </div>


                    <div class="filter-group" hidden>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Trạng
                            thái lớp</label>
                        <select id="filterTrangThai"
                            class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        </select>
                    </div>

                    <div class="pt-4 space-y-3">
                        <button id="applyFilters"
                            class="w-full flex items-center justify-center px-4 py-3 space-x-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 ease-in-out transform hover:-translate-y-0.5">
                            <i class="fas fa-filter btn-icon"></i>
                            <span class="font-medium">Áp dụng</span>
                        </button>

                        <!-- Reset Button -->
                        <button id="resetFilters"
                            class="w-full flex items-center justify-center px-4 py-3 space-x-3 bg-white hover:bg-gray-50 text-gray-700 rounded-lg shadow-lg hover:shadow-xl border border-gray-200 transition-all duration-200 ease-in-out transform hover:-translate-y-0.5">
                            <i class="fas fa-undo btn-icon"></i>
                            <span class="font-medium">Đặt lại</span>
                        </button>

                        <!-- Export Excel Button -->
                        <button id="exportExcel"
                            class="w-full flex items-center justify-center px-4 py-3 space-x-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 ease-in-out transform hover:-translate-y-0.5">
                            <i class="fas fa-file-excel btn-icon"></i>
                            <span class="font-medium">Xuất Excel</span>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 lg:ml-64 p-6">
            <div class="max-w-9xl mx-auto">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                    <div class="card-stats bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-indigo-100 dark:bg-indigo-900">
                                <i class="fas fa-box-open text-indigo-600 dark:text-indigo-400"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Tổng số lớp</p>
                                <p id="totalProducts" class="text-xl font-semibold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="card-stats bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 dark:bg-green-900">
                                <i class="fas fa-money-bill-wave text-green-600 dark:text-green-400"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Tổng số học viên</p>
                                <p id="totalRevenue" class="text-xl font-semibold text-gray-900 dark:text-white">0 ₫</p>
                            </div>
                        </div>
                    </div>

                    <div class="card-stats bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 dark:bg-yellow-900">
                                <i class="fas fa-calendar-day text-yellow-600 dark:text-yellow-400"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Tổng số học viên học thử
                                </p>
                                <p id="totalWorkDays" class="text-xl font-semibold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                    </div>


                </div>

                <!-- Table will be inserted here by JavaScript -->
            </div>
        </main>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden lg:hidden"></div>
    <!-- Thêm Modal HTML ngay trước thẻ đóng body -->
    <div id="attendanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-lg w-full max-w-7xl mx-auto max-h-[90vh] overflow-y-auto">
            <div class="p-8">
                <div class="flex justify-between items-start mb-6">
                    <div id="modalTitle" class="flex-1"></div>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="space-y-8">
                    <!-- Statistics Cards -->
                    <div id="attendanceStats"></div>

                    <!-- Attendance History Table -->
                    <div class="mt-8">
                        <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Chi tiết điểm danh theo học
                            viên</h4>
                        <div id="attendanceHistoryTable"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>@
    <script>


        const appId = '237238ed-4230-4db1-ab50-e492cea9cdba';
        const accessKey = 'V2-GAZkd-YsAqg-LBYbc-LRoOQ-2ZFzj-Imfj1-SodbW-9RtwD';
        const region = 'www';
        let danhsachlop = [];
        let diemdanh = [];
        let hocvien = [];
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }
        async function apiRequest(tableName, action, data, Properties) {

            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: action,
                        ...Properties,
                        ...data
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error("API Error:", error);
                throw error;
            }
        }

        // gồm các cột 
        async function fetchLopData() {
            try {
                const response = await apiRequest('LOP', 'Find', {}, {
                    Properties: { Selector: `Filter(LOP, [Trạng thái lớp]<>"Lớp chờ")` }
                });
                if (!Array.isArray(response) || response.length === 0) {
                    throw new Error("Invalid data received from API");
                }
                return response;
            } catch (error) {
                console.error("Error fetching data from AppSheet:", error);
                throw error;
            }
        }

        async function fetchDiemdanhData() {
            try {
                const response = await apiRequest('DIEMDANHHV', 'Find', {}, {
                    Properties: { Selector: `Filter(DIEMDANHHV, true)` }
                });
                if (!Array.isArray(response) || response.length === 0) {
                    throw new Error("Invalid data received from API");
                }
                return response;
            } catch (error) {
                console.error("Error fetching data from AppSheet:", error);
                throw error;
            }
        }

        async function fetchHocVien() {
            try {
                const response = await apiRequest('Danh sách học viên', 'Find', {}, {
                    Properties: { Selector: `Filter(Danh sách học viên,true)` }
                });
                if (!Array.isArray(response) || response.length === 0) {
                    throw new Error("Invalid data received from API");
                }
                return response;
            } catch (error) {
                console.error("Error fetching data from AppSheet:", error);
                throw error;
            }
        }

        function processClassData() {
            const processedData = danhsachlop.map(classItem => {
                // Get all students for this class based on IDLOP
                const classStudents = hocvien.filter(student => student.IDLOP === classItem.IDLOP);

                // Get attendance records for this class
                const classAttendance = diemdanh.filter(record => record.IDLOP === classItem.IDLOP);

                // Calculate statistics
                const totalStudents = classStudents.length;
                const presentCount = classAttendance.filter(record => record["TRẠNG THÁI"] === "P - Có mặt").length;
                const absentCount = classAttendance.filter(record => record["TRẠNG THÁI"] === "A - Vắng mặt").length;
                const tempStudents = classStudents.filter(student => student["Trạng thái lớp"] === "Học tạm").length;

                return {
                    ...classItem,
                    totalStudents,
                    presentCount,
                    absentCount,
                    tempStudents

                };
            });

            return processedData;
        }
        function renderDashboardTable() {
            const processedData = processClassData();

            // Update statistics cards
            document.getElementById('totalProducts').textContent = processedData.length;
            document.getElementById('totalRevenue').textContent = processedData.reduce((acc, curr) => acc + Number(curr.totalStudents), 0);
            document.getElementById('totalWorkDays').textContent = processedData.reduce((acc, curr) => acc + Number(curr.tempStudents), 0);

            // Create table HTML
            const tableHTML = `
        <div class="bg-white dark:bg-gray-800 shadow-lg rounded-lg overflow-hidden">
            <div class="p-4">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Danh sách lớp học</h2>
                    <div class="flex space-x-2">
                        <input type="text" 
                               id="searchInput"
                               placeholder="Tìm kiếm..." 
                               class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                       <thead class="bg-gray-50 dark:bg-gray-700">
    <tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tên lớp</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Chi nhánh</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">GVCN</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tổng HV</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">HV học thử</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Trạng thái</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Chi tiết</th>
    </tr>
</thead>
                        <tbody class="bg-white divide-y divide-gray-200 dark:divide-gray-700">
                           ${processedData.map(item => `
    <tr class="hover:bg-gray-50 dark:hover:bg-gray-600">
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item["Tên lớp"]}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item["Chi nhánh"]}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item["Giáo viên chủ nhiệm"]}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item.totalStudents}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
            <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">
                ${item.tempStudents}
            </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                ${item["Trạng thái lớp"] === "Đang học" ? "bg-green-100 text-green-800" :
                    item["Trạng thái lớp"] === "Dự kiến KG" ? "bg-yellow-100 text-yellow-800" :
                        "bg-gray-100 text-gray-800"}">
                ${item["Trạng thái lớp"]}
            </span>
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm">
            <button onclick="showAttendanceModal('${item.IDLOP}')" 
                    class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-3 py-1 rounded-md text-sm font-medium">
                <i class="fas fa-info-circle mr-1"></i> Chi tiết
            </button>
        </td>
    </tr>
`).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    `;

            // Insert table into main content
            const mainContent = document.querySelector('main .max-w-9xl');
            mainContent.insertAdjacentHTML('beforeend', tableHTML);

            // Add search functionality
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('tbody tr');

                rows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            });
        }
        // Hàm để populate các dropdown filters
        function populateFilterDropdowns() {
            // Lấy unique values từ data
            const chinhanh = [...new Set(danhsachlop.map(item => item["Chi nhánh"]))];
            const gvcn = [...new Set(danhsachlop.map(item => item["Giáo viên chủ nhiệm"]))];
            const khoahoc = [...new Set(danhsachlop.map(item => item["TÊN KHÓA HỌC"]))];
            const trangthai = [...new Set(danhsachlop.map(item => item["Trạng thái lớp"]))];

            // Populate Chi nhánh dropdown
            const filterKhuVuc = document.getElementById('filterKhuVuc');
            filterKhuVuc.innerHTML = '<option value="">Tất cả chi nhánh</option>' +
                chinhanh.sort().map(cn => `<option value="${cn}">${cn}</option>`).join('');

            // Populate GVCN dropdown
            const filterChucVu = document.getElementById('filterChucVu');
            filterChucVu.innerHTML = '<option value="">Tất cả giáo viên</option>' +
                gvcn.sort().map(gv => `<option value="${gv}">${gv}</option>`).join('');

            // Populate Khóa học dropdown
            const filterMaNhanVien = document.getElementById('filterMaNhanVien');
            filterMaNhanVien.innerHTML = '<option value="">Tất cả khóa học</option>' +
                khoahoc.sort().map(kh => `<option value="${kh}">${kh}</option>`).join('');

            // Populate Trạng thái dropdown
            const filterTrangThai = document.getElementById('filterTrangThai');
            filterTrangThai.innerHTML = '<option value="">Tất cả trạng thái</option>' +
                trangthai.sort().map(tt => `<option value="${tt}">${tt}</option>`).join('');
        }
        // Thêm các hàm này vào phần script

        function closeModal() {
            const modal = document.getElementById('attendanceModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');

            // Clear filter container when closing modal
            const modalContent = document.querySelector('#attendanceHistoryTable').parentNode;
            const filterContainers = modalContent.querySelectorAll('.mb-6.grid, .mb-6.flex');
            filterContainers.forEach(container => container.remove());

            // Clear attendance table content
            document.getElementById('attendanceHistoryTable').innerHTML = '';
            document.getElementById('attendanceStats').innerHTML = '';
        }
        function showAttendanceModal(idlop) {
            const modal = document.getElementById('attendanceModal');
            const classInfo = danhsachlop.find(c => c.IDLOP === idlop);
            const classAttendance = diemdanh.filter(record => record.IDLOP === idlop);
            const classStudents = hocvien.filter(student => student.IDLOP === idlop);

            // Get unique dates for all attendance records
            const allDates = [...new Set(classAttendance.map(record => record["NGÀY"]))].sort();

            // Create pivot data structure
            const pivotData = classStudents.map(student => {
                const studentAttendance = {};
                // Initialize all dates with empty status
                allDates.forEach(date => {
                    studentAttendance[date] = '';
                });
                // Fill in actual attendance data
                classAttendance
                    .filter(record => record["KEYKH"] === student.IDKH)
                    .forEach(record => {
                        studentAttendance[record["NGÀY"]] = record["TRẠNG THÁI"];
                    });

                // Calculate student statistics
                const stats = {
                    present: Object.values(studentAttendance).filter(status => status === "P - Có mặt").length,
                    absent: Object.values(studentAttendance).filter(status => status === "A - Vắng").length,
                    late: Object.values(studentAttendance).filter(status => status === "L - Trễ").length,
                    excused: Object.values(studentAttendance).filter(status => status === "M - Có Phép").length,
                    quit: Object.values(studentAttendance).filter(status => status === "S - Nghỉ Luôn").length
                };

                return {
                    student,
                    attendance: studentAttendance,
                    stats
                };
            });

            // Calculate overall statistics
            const stats = {
                present: classAttendance.filter(r => r["TRẠNG THÁI"] === "P - Có mặt").length,
                absent: classAttendance.filter(r => r["TRẠNG THÁI"] === "A - Vắng").length,
                late: classAttendance.filter(r => r["TRẠNG THÁI"] === "L - Trễ").length,
                excused: classAttendance.filter(r => r["TRẠNG THÁI"] === "M - Có Phép").length,
                quit: classAttendance.filter(r => r["TRẠNG THÁI"] === "S - Nghỉ Luôn").length
            };

            // Update modal title with class info
            document.getElementById('modalTitle').innerHTML = `
        <div class="text-xl font-semibold mb-2">${classInfo["Tên lớp"]}</div>
        <div class="text-sm text-gray-600">
            <span class="mr-4">GVCN: ${classInfo["Giáo viên chủ nhiệm"]}</span>
            <span class="mr-4">Số buổi: ${classInfo["Số buổi học"] || 'N/A'}</span>
            <span>Thời gian: ${classInfo["Giờ học"] || 'N/A'}</span>
        </div>
    `;

            // Render statistics cards with larger size
            const statsHTML = `
        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6">
            
            <div class="bg-green-100 p-6 rounded-lg">
                <div class="font-medium text-green-800 text-lg">Có mặt</div>
                <div class="text-3xl font-bold text-green-900">${stats.present}</div>
            </div>
            <div class="bg-red-100 p-6 rounded-lg">
                <div class="font-medium text-red-800 text-lg">Vắng mặt</div>
                <div class="text-3xl font-bold text-red-900">${stats.absent}</div>
            </div>
            <div class="bg-yellow-100 p-6 rounded-lg">
                <div class="font-medium text-yellow-800 text-lg">Đi trễ</div>
                <div class="text-3xl font-bold text-yellow-900">${stats.late}</div>
            </div>
            <div class="bg-purple-100 p-6 rounded-lg">
                <div class="font-medium text-purple-800 text-lg">Có phép</div>
                <div class="text-3xl font-bold text-purple-900">${stats.excused}</div>
            </div>
            <div class="bg-gray-100 p-6 rounded-lg">
                <div class="font-medium text-gray-800 text-lg">Nghỉ luôn</div>
                <div class="text-3xl font-bold text-gray-900">${stats.quit}</div>
            </div>
        </div>
    `;
            document.getElementById('attendanceStats').innerHTML = statsHTML;

            // Render pivot table
            const pivotTableHTML = `
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase sticky left-0 bg-gray-50 dark:bg-gray-700">Học viên</th>
                        ${allDates.map((date, index) => `
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">
                                Buổi ${index + 1}<br>${formatDate(date)}
                            </th>
                        `).join('')}
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase bg-gray-100">Có mặt</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase bg-gray-100">Vắng</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase bg-gray-100">Trễ</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase bg-gray-100">Có phép</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase bg-gray-100">Nghỉ luôn</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200 dark:divide-gray-700">
                    ${pivotData.map(row => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white">
                                ${row.student["Tên KH"]}
                            </td>
                            ${allDates.map(date => `
                                <td class="px-4 py-3 text-center">
                                    ${row.attendance[date] ? `
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(row.attendance[date])}">
                                            ${row.attendance[date].split(' - ')[0]}
                                        </span>
                                    ` : ''}
                                </td>
                            `).join('')}
                            <td class="px-4 py-3 text-center text-sm font-medium text-green-600 bg-gray-50">${row.stats.present}</td>
                            <td class="px-4 py-3 text-center text-sm font-medium text-red-600 bg-gray-50">${row.stats.absent}</td>
                            <td class="px-4 py-3 text-center text-sm font-medium text-yellow-600 bg-gray-50">${row.stats.late}</td>
                            <td class="px-4 py-3 text-center text-sm font-medium text-purple-600 bg-gray-50">${row.stats.excused}</td>
                            <td class="px-4 py-3 text-center text-sm font-medium text-gray-600 bg-gray-50">${row.stats.quit}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
            document.getElementById('attendanceHistoryTable').innerHTML = pivotTableHTML;
            // Lưu ID lớp hiện tại để dùng cho xuất Excel
            window.currentClassId = idlop;

            // Thêm bộ lọc sau khi render bảng
            addAttendanceFilters();
            // Show modal with larger size
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function getStatusColor(status) {
            switch (status) {
                case 'P - Có mặt':
                    return 'bg-green-100 text-green-800';
                case 'A - Vắng':
                    return 'bg-red-100 text-red-800';
                case 'L - Trễ':
                    return 'bg-yellow-100 text-yellow-800';
                case 'M - Có Phép':
                    return 'bg-purple-100 text-purple-800';
                case 'S - Nghỉ Luôn':
                    return 'bg-gray-100 text-gray-800';
                default:
                    return 'bg-gray-100 text-gray-800';
            }
        }

        // Thêm hàm xuất Excel cho bảng tổng quan
        function exportDashboardToExcel() {
            const processedData = processClassData();
            const exportData = processedData.map(item => ({
                'Tên lớp': item["Tên lớp"],
                'Chi nhánh': item["Chi nhánh"],
                'Giáo viên chủ nhiệm': item["Giáo viên chủ nhiệm"],
                'Tổng học viên': item.totalStudents,
                'Học viên học thử': item.tempStudents,
                'Số buổi học': item["Số buổi học"],
                'Trạng thái': item["Trạng thái lớp"]
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Tổng quan lớp học");
            XLSX.writeFile(wb, "ThongKeLopHoc.xlsx");
        }
        // Thêm hàm xuất Excel cho bảng chi tiết điểm danh
        function exportAttendanceToExcel(idlop) {
            const classInfo = danhsachlop.find(c => c.IDLOP === idlop);
            const classAttendance = diemdanh.filter(record => record.IDLOP === idlop);
            const classStudents = hocvien.filter(student => student.IDLOP === idlop);
            const allDates = [...new Set(classAttendance.map(record => record["NGÀY"]))].sort();

            // Tạo dữ liệu xuất Excel
            const exportData = classStudents.map(student => {
                const studentAttendance = {};
                allDates.forEach(date => {
                    studentAttendance[`Buổi ${allDates.indexOf(date) + 1} (${date})`] = '';
                });

                classAttendance
                    .filter(record => record["KEYKH"] === student.IDKH)
                    .forEach(record => {
                        const columnName = `Buổi ${allDates.indexOf(record["NGÀY"]) + 1} (${record["NGÀY"]})`;
                        studentAttendance[columnName] = record["TRẠNG THÁI"];
                    });

                // Tính toán thống kê
                const stats = {
                    'Có mặt': Object.values(studentAttendance).filter(status => status === "P - Có mặt").length,
                    'Vắng': Object.values(studentAttendance).filter(status => status === "A - Vắng").length,
                    'Trễ': Object.values(studentAttendance).filter(status => status === "L - Trễ").length,
                    'Có phép': Object.values(studentAttendance).filter(status => status === "M - Có Phép").length,
                    'Nghỉ luôn': Object.values(studentAttendance).filter(status => status === "S - Nghỉ Luôn").length
                };

                return {
                    'Học viên': student["Tên KH"],
                    ...studentAttendance,
                    ...stats
                };
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Chi tiết điểm danh");
            XLSX.writeFile(wb, `DiemDanh_${classInfo["Tên lớp"]}.xlsx`);
        }

        // Thêm chức năng lọc cho bảng chi tiết điểm danh
        function addAttendanceFilters() {
            const filterHTML = `
        <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
               
                <input type="text" 
                    id="studentFilter"
                    placeholder="Tên học viên..." 
                    class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            </div>
            <div class="mb-6 flex justify-between items-center">
            <button onclick="resetAttendanceFilters()" 
                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                <i class="fas fa-undo mr-2"></i>Đặt lại bộ lọc
            </button>
            <button onclick="exportAttendanceToExcel('${currentClassId}')" 
                class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                <i class="fas fa-file-excel mr-2"></i>Xuất Excel
            </button>
        </div>
        </div>
       
    `;

            // Thêm HTML bộ lọc vào trước bảng
            const filterContainer = document.createElement('div');
            filterContainer.innerHTML = filterHTML;
            document.getElementById('attendanceHistoryTable').parentNode.insertBefore(
                filterContainer,
                document.getElementById('attendanceHistoryTable')
            );

            // Thêm event listeners cho bộ lọc
            const studentFilter = document.getElementById('studentFilter');


            [studentFilter].forEach(filter => {
                filter.addEventListener('change', applyAttendanceFilters);
            });

            studentFilter.addEventListener('input', applyAttendanceFilters);
        }

        function applyAttendanceFilters() {
            const studentFilter = document.getElementById('studentFilter').value.toLowerCase();

            const rows = document.querySelectorAll('#attendanceHistoryTable tbody tr');

            rows.forEach(row => {
                const studentName = row.querySelector('td:first-child').textContent.toLowerCase();
                const attendanceCells = Array.from(row.querySelectorAll('td')).slice(1, -5); // Exclude summary columns

                let showRow = true;

                // Lọc theo tên học viên
                if (studentFilter && !studentName.includes(studentFilter)) {
                    showRow = false;
                }





                row.style.display = showRow ? '' : 'none';
            });
        }

        function resetAttendanceFilters() {
            document.getElementById('studentFilter').value = '';

            const rows = document.querySelectorAll('#attendanceHistoryTable tbody tr');
            rows.forEach(row => row.style.display = '');
        }
        // Modify the init() function to include table rendering
        async function init() {
            try {
                danhsachlop = await fetchLopData();
                diemdanh = await fetchDiemdanhData();
                hocvien = await fetchHocVien();

                console.log(danhsachlop);
                console.log(diemdanh);
                console.log(hocvien);
            } catch (error) {
                console.error('Error initializing dashboard:', error);
            }
        }
        // Hàm để lọc và xử lý dữ liệu
        function getFilteredData() {
            const chinhanh = document.getElementById('filterKhuVuc').value;
            const gvcn = document.getElementById('filterChucVu').value;
            const khoahoc = document.getElementById('filterMaNhanVien').value;
            const trangthai = document.getElementById('filterTrangThai').value;

            // Lọc dữ liệu
            return danhsachlop.filter(item => {
                const matchChinhanh = !chinhanh || item["Chi nhánh"] === chinhanh;
                const matchGVCN = !gvcn || item["Giáo viên chủ nhiệm"] === gvcn;
                const matchKhoahoc = !khoahoc || item["TÊN KHÓA HỌC"] === khoahoc;
                const matchTrangthai = !trangthai || item["Trạng thái lớp"] === trangthai;

                return matchChinhanh && matchGVCN && matchKhoahoc && matchTrangthai;
            });
        }

        // Hàm để cập nhật thống kê
        function updateStatistics(filteredData) {
            const processedData = filteredData.map(classItem => {
                const classStudents = hocvien.filter(student => student.IDLOP === classItem.IDLOP);
                const tempStudents = classStudents.filter(student => student["Trạng thái lớp"] === "Học tạm").length;

                return {
                    ...classItem,
                    totalStudents: classStudents.length,
                    tempStudents
                };
            });

            // Cập nhật các thẻ thống kê
            document.getElementById('totalProducts').textContent = processedData.length;
            document.getElementById('totalRevenue').textContent = processedData.reduce((acc, curr) => acc + curr.totalStudents, 0);
            document.getElementById('totalWorkDays').textContent = processedData.reduce((acc, curr) => acc + curr.tempStudents, 0);

            return processedData;
        }
        // Hàm để cập nhật bảng hiện tại
        function updateTable(processedData) {
            const tbody = document.querySelector('tbody');
            if (!tbody) return;

            tbody.innerHTML = processedData.map(item => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-600">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item["Tên lớp"]}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item["Chi nhánh"]}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item["Giáo viên chủ nhiệm"]}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item.totalStudents}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">
                    ${item.tempStudents}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                    ${item["Trạng thái lớp"] === "Đang học" ? "bg-green-100 text-green-800" :
                    item["Trạng thái lớp"] === "Dự kiến KG" ? "bg-yellow-100 text-yellow-800" :
                        "bg-gray-100 text-gray-800"}">
                    ${item["Trạng thái lớp"]}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <button onclick="showAttendanceModal('${item.IDLOP}')" 
                        class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-3 py-1 rounded-md text-sm font-medium">
                    <i class="fas fa-info-circle mr-1"></i> Chi tiết
                </button>
            </td>
        </tr>
    `).join('');
        }
        // Hàm áp dụng bộ lọc
        // Hàm áp dụng bộ lọc chính
        function applyFilters() {
            // Lấy dữ liệu đã lọc
            const filteredData = getFilteredData();

            // Xử lý và cập nhật thống kê
            const processedData = updateStatistics(filteredData);

            // Cập nhật bảng
            updateTable(processedData);

            // Đóng sidebar trên mobile
            if (window.innerWidth < 1024) {
                document.getElementById('filtersSidebar').classList.add('-translate-x-full');
                document.getElementById('overlay').classList.add('hidden');
            }
        }

        // Hàm xuất Excel
        function exportToExcel() {
            const processedData = processClassData();
            const exportData = processedData.map(item => ({
                'Tên lớp': item["Tên lớp"],
                'Chi nhánh': item["Chi nhánh"],
                'Giáo viên chủ nhiệm': item["Giáo viên chủ nhiệm"],
                'Tổng học viên': item.totalStudents,
                'Học viên học thử': item.tempStudents,
                'Số buổi học': item["Số buổi học"],
                'Trạng thái': item["Trạng thái lớp"]
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Thống kê lớp học");
            XLSX.writeFile(wb, `ThongKeLopHoc_${new Date().toLocaleDateString()}.xlsx`);
        }
        // Hàm reset bộ lọc đã được tối ưu
        function resetFilters() {
            // Reset tất cả các giá trị filter về mặc định
            document.getElementById('filterKhuVuc').value = '';
            document.getElementById('filterChucVu').value = '';
            document.getElementById('filterMaNhanVien').value = '';
            document.getElementById('filterTrangThai').value = '';

            // Lấy lại toàn bộ dữ liệu ban đầu
            const processedData = processClassData();

            // Cập nhật thống kê
            document.getElementById('totalProducts').textContent = processedData.length;
            document.getElementById('totalRevenue').textContent = processedData.reduce((acc, curr) => acc + curr.totalStudents, 0);
            document.getElementById('totalWorkDays').textContent = processedData.reduce((acc, curr) => acc + curr.tempStudents, 0);

            // Cập nhật bảng hiện tại thay vì render lại
            const tbody = document.querySelector('tbody');
            if (!tbody) return;

            tbody.innerHTML = processedData.map(item => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-600">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item["Tên lớp"]}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item["Chi nhánh"]}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item["Giáo viên chủ nhiệm"]}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">${item.totalStudents}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white">
                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800">
                    ${item.tempStudents}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                    ${item["Trạng thái lớp"] === "Đang học" ? "bg-green-100 text-green-800" :
                    item["Trạng thái lớp"] === "Dự kiến KG" ? "bg-yellow-100 text-yellow-800" :
                        "bg-gray-100 text-gray-800"}">
                    ${item["Trạng thái lớp"]}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <button onclick="showAttendanceModal('${item.IDLOP}')" 
                        class="bg-indigo-100 text-indigo-700 hover:bg-indigo-200 px-3 py-1 rounded-md text-sm font-medium">
                    <i class="fas fa-info-circle mr-1"></i> Chi tiết
                </button>
            </td>
        </tr>
    `).join('');

            // Reset search input nếu có
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.value = '';
            }
        }

        // Add event listener for mobile sidebar toggle
        document.getElementById('toggleFilters').addEventListener('click', function () {
            const sidebar = document.getElementById('filtersSidebar');
            const overlay = document.getElementById('overlay');

            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        });

        document.getElementById('overlay').addEventListener('click', function () {
            const sidebar = document.getElementById('filtersSidebar');
            const overlay = document.getElementById('overlay');

            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        });


        // Cập nhật event listener
        // Update DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', async function () {
            try {
                document.getElementById('loading').classList.remove('hidden');

                await init();
                populateFilterDropdowns();
                renderDashboardTable(); // Call render only once here

                // Add event listeners for buttons
                document.getElementById('applyFilters').addEventListener('click', applyFilters);
                document.getElementById('resetFilters').addEventListener('click', resetFilters);
                document.getElementById('exportExcel').addEventListener('click', exportToExcel);

            } catch (error) {
                console.error('Error initializing dashboard:', error);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        });
        // Thêm vào cuối file script
        window.addEventListener('click', function (event) {
            const modal = document.getElementById('attendanceModal');
            if (event.target === modal) {
                closeModal();
            }
        });
    </script>

</body>

</html>